<!-- ÁRBOL DE CONOCIMIENTO 3D COMPLETO - KOBALTO HOMESCHOOLING -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu Árbol de Conocimiento - Kobalto</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: #0a0e1a;
            color: #EAEEFF;
            overflow-x: hidden;
        }

        .kobalto-tree-app {
            position: relative;
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            min-height: 100vh;
            background: linear-gradient(135deg, #0a1128 0%, #042454 50%, #0a1128 100%);
        }

        /* Header */
        .tree-header {
            text-align: center;
            padding: 40px 20px 20px;
            position: relative;
            z-index: 10;
        }

        .tree-header h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.8rem;
            font-weight: 800;
            margin: 0 0 10px 0;
            background: linear-gradient(135deg, #6efacc 0%, #D1A517 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tree-header p {
            font-size: 1.1rem;
            color: #EAEEFF;
            opacity: 0.8;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
            padding: 15px 25px;
            background: rgba(64, 80, 134, 0.2);
            border-radius: 15px;
            border: 1px solid rgba(110, 250, 204, 0.2);
            min-width: 120px;
        }

        .stat-icon {
            font-size: 1.5rem;
            color: #D1A517;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
            color: #6efacc;
            display: block;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #EAEEFF;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Controls */
        .controls-panel {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 12px 24px;
            background: rgba(64, 80, 134, 0.3);
            border: 2px solid rgba(110, 250, 204, 0.3);
            border-radius: 25px;
            color: #6efacc;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-btn:hover {
            background: rgba(110, 250, 204, 0.2);
            border-color: #6efacc;
            transform: translateY(-2px);
        }

        .control-btn.active {
            background: rgba(110, 250, 204, 0.3);
            border-color: #6efacc;
        }

        .control-btn i {
            font-size: 1.1rem;
        }

        /* Main Layout */
        .tree-main {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            padding: 0 20px 20px;
            position: relative;
        }

        .tree-canvas-container {
            position: relative;
            background: rgba(4, 36, 84, 0.2);
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid rgba(110, 250, 204, 0.1);
        }

        #tree3dCanvas {
            width: 100%;
            height: 700px;
            display: block;
            cursor: grab;
        }

        #tree3dCanvas:active {
            cursor: grabbing;
        }

        .canvas-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(4, 36, 84, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 25px;
            color: #6efacc;
            font-size: 0.9rem;
            font-weight: 600;
            border: 1px solid rgba(110, 250, 204, 0.3);
            z-index: 10;
            pointer-events: none;
        }

        .canvas-controls i {
            margin: 0 5px;
            color: #D1A517;
        }

        /* Side Panel */
        .side-panel {
            background: rgba(4, 36, 84, 0.4);
            border-radius: 20px;
            padding: 25px;
            border: 2px solid rgba(110, 250, 204, 0.1);
            max-height: 700px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }

        .side-panel::-webkit-scrollbar {
            width: 8px;
        }

        .side-panel::-webkit-scrollbar-track {
            background: rgba(4, 36, 84, 0.3);
            border-radius: 10px;
        }

        .side-panel::-webkit-scrollbar-thumb {
            background: #6efacc;
            border-radius: 10px;
        }

        .panel-section {
            margin-bottom: 25px;
        }

        .panel-section h3 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: #6efacc;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .branch-info {
            background: rgba(64, 80, 134, 0.2);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(110, 250, 204, 0.2);
            margin-bottom: 15px;
        }

        .branch-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #EAEEFF;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .branch-progress {
            margin: 15px 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #EAEEFF;
            opacity: 0.8;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(64, 80, 134, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6efacc 0%, #D1A517 100%);
            border-radius: 10px;
            transition: width 1s ease-out;
        }

        .next-level {
            margin-top: 15px;
            padding: 15px;
            background: rgba(110, 250, 204, 0.1);
            border-radius: 10px;
            border-left: 3px solid #6efacc;
        }

        .next-level-title {
            font-weight: 600;
            color: #6efacc;
            margin-bottom: 5px;
        }

        .next-level-desc {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .action-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #D1A517 0%, #B8900F 100%);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(209, 165, 23, 0.4);
        }

        /* Badges */
        .badges-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .badge-item {
            background: rgba(64, 80, 134, 0.2);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .badge-item.earned {
            border-color: #D1A517;
            background: rgba(209, 165, 23, 0.1);
        }

        .badge-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            opacity: 0.3;
        }

        .badge-item.earned .badge-icon {
            opacity: 1;
        }

        .badge-name {
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, #6efacc 0%, rgba(110, 250, 204, 0.2) 100%);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding-left: 10px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -23px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #6efacc;
            border: 2px solid #042454;
        }

        .timeline-item.future::before {
            background: rgba(110, 250, 204, 0.3);
        }

        .timeline-date {
            font-size: 0.8rem;
            color: #6efacc;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .timeline-content {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .timeline-item.future .timeline-content {
            opacity: 0.5;
            font-style: italic;
        }

        /* Tooltip */
        .custom-tooltip {
            position: fixed;
            background: rgba(4, 36, 84, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 12px;
            border: 2px solid #6efacc;
            color: #EAEEFF;
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 300px;
            box-shadow: 0 10px 40px rgba(4, 36, 84, 0.8);
        }

        .custom-tooltip.visible {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 700;
            color: #6efacc;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .tooltip-content {
            margin-bottom: 8px;
        }

        .tooltip-meta {
            font-size: 0.8rem;
            opacity: 0.7;
            border-top: 1px solid rgba(110, 250, 204, 0.2);
            padding-top: 8px;
            margin-top: 8px;
        }

        /* Tour Guide */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .tour-overlay.active {
            display: flex;
        }

        .tour-card {
            background: linear-gradient(135deg, #042454 0%, #0a1128 100%);
            padding: 40px;
            border-radius: 25px;
            max-width: 500px;
            text-align: center;
            border: 3px solid #6efacc;
            box-shadow: 0 20px 60px rgba(110, 250, 204, 0.3);
            animation: tourPulse 2s ease-in-out infinite;
        }

        @keyframes tourPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .tour-icon {
            font-size: 4rem;
            color: #D1A517;
            margin-bottom: 20px;
        }

        .tour-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            color: #6efacc;
            margin-bottom: 15px;
        }

        .tour-message {
            font-size: 1.1rem;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .tour-progress {
            font-size: 0.9rem;
            opacity: 0.6;
            margin-bottom: 20px;
        }

        .tour-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .tour-btn {
            padding: 12px 30px;
            border-radius: 25px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid;
        }

        .tour-btn-primary {
            background: #D1A517;
            color: #fff;
            border-color: #D1A517;
        }

        .tour-btn-primary:hover {
            background: #B8900F;
            transform: translateY(-2px);
        }

        .tour-btn-secondary {
            background: transparent;
            color: #6efacc;
            border-color: #6efacc;
        }

        .tour-btn-secondary:hover {
            background: rgba(110, 250, 204, 0.1);
        }

        /* Celebration Effect */
        .celebration-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9998;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #D1A517;
            animation: confettiFall 3s ease-out forwards;
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a1128 0%, #042454 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader {
            width: 80px;
            height: 80px;
            border: 6px solid rgba(110, 250, 204, 0.2);
            border-top: 6px solid #6efacc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 25px;
            color: #6efacc;
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .tree-main {
                grid-template-columns: 1fr;
            }

            .side-panel {
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .tree-header h1 {
                font-size: 2rem;
            }

            .stats-bar {
                gap: 15px;
            }

            .stat-item {
                padding: 12px 20px;
                min-width: 100px;
            }

            #tree3dCanvas {
                height: 500px;
            }

            .controls-panel {
                gap: 10px;
            }

            .control-btn {
                padding: 10px 18px;
                font-size: 0.9rem;
            }

            .tour-card {
                padding: 30px 25px;
                margin: 20px;
            }
        }

        @media (max-width: 480px) {
            #tree3dCanvas {
                height: 400px;
            }

            .badges-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Mode 2D */
        .tree-2d-view {
            display: none;
            padding: 30px;
        }

        .tree-2d-view.active {
            display: block;
        }

        .branches-diagram {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .branch-2d {
            background: rgba(64, 80, 134, 0.2);
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid;
            transition: all 0.3s;
        }

        .branch-2d:hover {
            background: rgba(64, 80, 134, 0.3);
            transform: translateX(10px);
        }

        .branch-2d.status-low {
            border-color: #FF6B6B;
        }

        .branch-2d.status-medium {
            border-color: #FFD93D;
        }

        .branch-2d.status-high {
            border-color: #6BCF7F;
        }

        .branch-2d.status-excellent {
            border-color: #D1A517;
        }

        /* Motivational Banner */
        .motivation-banner {
            background: linear-gradient(135deg, rgba(110, 250, 204, 0.1) 0%, rgba(209, 165, 23, 0.1) 100%);
            padding: 20px 30px;
            margin: 20px;
            border-radius: 15px;
            border: 2px solid rgba(110, 250, 204, 0.3);
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            color: #6efacc;
        }

        .motivation-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #D1A517;
        }
    </style>
</head>
<body>
    <div class="kobalto-tree-app">
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loader"></div>
            <div class="loading-text">Creciendo tu árbol de conocimiento...</div>
        </div>

        <!-- Tour Guide -->
        <div class="tour-overlay" id="tourOverlay">
            <div class="tour-card">
                <div class="tour-icon" id="tourIcon">
                    <i class="fas fa-seedling"></i>
                </div>
                <h2 class="tour-title" id="tourTitle">Bienvenido a tu Árbol de Conocimiento</h2>
                <p class="tour-message" id="tourMessage">Este es tu espacio personal de aprendizaje. Cada rama representa un área de conocimiento que irás desarrollando.</p>
                <p class="tour-progress" id="tourProgress">Paso 1 de 5</p>
                <div class="tour-buttons">
                    <button class="tour-btn tour-btn-secondary" id="tourSkip">Omitir</button>
                    <button class="tour-btn tour-btn-primary" id="tourNext">Siguiente</button>
                </div>
            </div>
        </div>

        <!-- Celebration Container -->
        <div class="celebration-container" id="celebrationContainer"></div>

        <!-- Header -->
        <div class="tree-header">
            <h1>Tu Árbol de Conocimiento</h1>
            <p>Cada rama crece contigo. Explora tu progreso y sigue aprendiendo.</p>

            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-icon"><i class="fas fa-code-branch"></i></div>
                    <span class="stat-value" id="totalBranches">17</span>
                    <span class="stat-label">Ramas Activas</span>
                </div>
                <div class="stat-item">
                    <div class="stat-icon"><i class="fas fa-layer-group"></i></div>
                    <span class="stat-value" id="totalLevels">42</span>
                    <span class="stat-label">Niveles Certificados</span>
                </div>
                <div class="stat-item">
                    <div class="stat-icon"><i class="fas fa-fire"></i></div>
                    <span class="stat-value" id="streakDays">12</span>
                    <span class="stat-label">Días de Racha</span>
                </div>
                <div class="stat-item">
                    <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                    <span class="stat-value" id="growthRate">+23%</span>
                    <span class="stat-label">Este Mes</span>
                </div>
            </div>
        </div>

        <!-- Motivational Banner -->
        <div class="motivation-banner" id="motivationBanner">
            <div class="motivation-icon"><i class="fas fa-star"></i></div>
            <div id="motivationText">¡Excelente progreso! Llevas 12 días consecutivos aprendiendo.</div>
        </div>

        <!-- Controls -->
        <div class="controls-panel">
            <button class="control-btn active" id="viewMode3D">
                <i class="fas fa-cube"></i>
                Vista 3D
            </button>
            <button class="control-btn" id="viewMode2D">
                <i class="fas fa-sitemap"></i>
                Vista 2D
            </button>
            <button class="control-btn" id="viewModeOverview">
                <i class="fas fa-compress"></i>
                Vista General
            </button>
            <button class="control-btn" id="viewModeDetailed">
                <i class="fas fa-expand"></i>
                Vista Detallada
            </button>
            <button class="control-btn" id="timelineToggle">
                <i class="fas fa-clock"></i>
                Ver Evolución
            </button>
            <button class="control-btn" id="restartTour">
                <i class="fas fa-question-circle"></i>
                Tour Guiado
            </button>
        </div>

        <!-- Main Content -->
        <div class="tree-main">
            <!-- 3D Canvas -->
            <div class="tree-canvas-container" id="canvas3DContainer">
                <canvas id="tree3dCanvas"></canvas>
                <div class="canvas-controls">
                    <i class="fas fa-mouse"></i> Arrastra para rotar
                    <span style="margin: 0 10px;">•</span>
                    <i class="fas fa-computer-mouse"></i> Rueda para zoom
                    <span style="margin: 0 10px;">•</span>
                    <i class="fas fa-hand-pointer"></i> Click en ramas para info
                </div>
            </div>

            <!-- 2D View -->
            <div class="tree-2d-view" id="tree2DView">
                <div class="branches-diagram" id="branchesDiagram">
                    <!-- Se poblará dinámicamente -->
                </div>
            </div>

            <!-- Side Panel -->
            <div class="side-panel">
                <!-- Branch Info Section -->
                <div class="panel-section">
                    <h3><i class="fas fa-info-circle"></i> Información de Rama</h3>
                    <div id="branchInfoContent">
                        <p style="text-align: center; opacity: 0.6; padding: 40px 20px;">
                            <i class="fas fa-hand-pointer" style="font-size: 3rem; display: block; margin-bottom: 15px; color: #D1A517;"></i>
                            Haz click en una rama del árbol para ver información detallada
                        </p>
                    </div>
                </div>

                <!-- Badges Section -->
                <div class="panel-section">
                    <h3><i class="fas fa-trophy"></i> Logros</h3>
                    <div class="badges-grid">
                        <div class="badge-item earned">
                            <div class="badge-icon"><i class="fas fa-seedling"></i></div>
                            <div class="badge-name">Primera Rama</div>
                        </div>
                        <div class="badge-item earned">
                            <div class="badge-icon"><i class="fas fa-fire"></i></div>
                            <div class="badge-name">Racha 10 Días</div>
                        </div>
                        <div class="badge-item">
                            <div class="badge-icon"><i class="fas fa-star"></i></div>
                            <div class="badge-name">5 Excelencias</div>
                        </div>
                        <div class="badge-item">
                            <div class="badge-icon"><i class="fas fa-crown"></i></div>
                            <div class="badge-name">Pilar Completo</div>
                        </div>
                        <div class="badge-item earned">
                            <div class="badge-icon"><i class="fas fa-bolt"></i></div>
                            <div class="badge-name">Aprendiz Rápido</div>
                        </div>
                        <div class="badge-item">
                            <div class="badge-icon"><i class="fas fa-balance-scale"></i></div>
                            <div class="badge-name">Árbol Equilibrado</div>
                        </div>
                    </div>
                </div>

                <!-- Timeline Section -->
                <div class="panel-section">
                    <h3><i class="fas fa-history"></i> Actividad Reciente</h3>
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-date">Hoy, 14:30</div>
                            <div class="timeline-content">
                                <i class="fas fa-certificate"></i> Certificado Nivel 6 - Programación
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-date">Ayer</div>
                            <div class="timeline-content">
                                <i class="fas fa-book-open"></i> Completada sesión de Matemáticas
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-date">3 días atrás</div>
                            <div class="timeline-content">
                                <i class="fas fa-trophy"></i> Desbloqueado logro "Racha 10 Días"
                            </div>
                        </div>
                        <div class="timeline-item future">
                            <div class="timeline-date">Próximo: 5 días</div>
                            <div class="timeline-content">
                                <i class="fas fa-target"></i> Examen Nivel 7 - Programación
                            </div>
                        </div>
                        <div class="timeline-item future">
                            <div class="timeline-date">Predicción: 2 semanas</div>
                            <div class="timeline-content">
                                <i class="fas fa-star"></i> Completarás Pilar Tecnología
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Tooltip -->
        <div class="custom-tooltip" id="customTooltip">
            <div class="tooltip-title" id="tooltipTitle"></div>
            <div class="tooltip-content" id="tooltipContent"></div>
            <div class="tooltip-meta" id="tooltipMeta"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // ==================== DATOS DEL ESTUDIANTE ====================
        const studentData = {
            branches: [
                {
                    id: 'matematicas',
                    name: 'Matemáticas',
                    icon: 'fa-calculator',
                    currentLevel: 6,
                    maxLevel: 10,
                    color: 0x6BCF7F,
                    nextLevel: 'Álgebra Lineal',
                    description: 'Fundamentos matemáticos para ciencia y tecnología',
                    lastActivity: 'Hace 2 días',
                    predictedDays: 14
                },
                {
                    id: 'programacion',
                    name: 'Programación',
                    icon: 'fa-code',
                    currentLevel: 9,
                    maxLevel: 12,
                    color: 0xD1A517,
                    nextLevel: 'Arquitectura de Software',
                    description: 'Desarrollo full-stack y diseño de sistemas',
                    lastActivity: 'Hoy',
                    predictedDays: 5
                },
                {
                    id: 'lengua',
                    name: 'Lengua Española',
                    icon: 'fa-book',
                    currentLevel: 5,
                    maxLevel: 10,
                    color: 0xFFD93D,
                    nextLevel: 'Literatura Contemporánea',
                    description: 'Comunicación efectiva y análisis literario',
                    lastActivity: 'Ayer',
                    predictedDays: 21
                },
                {
                    id: 'ciencias',
                    name: 'Ciencias',
                    icon: 'fa-flask',
                    currentLevel: 4,
                    maxLevel: 10,
                    color: 0x6efacc,
                    nextLevel: 'Química Orgánica',
                    description: 'Comprensión del mundo natural',
                    lastActivity: 'Hace 3 días',
                    predictedDays: 28
                },
                {
                    id: 'historia',
                    name: 'Historia',
                    icon: 'fa-landmark',
                    currentLevel: 3,
                    maxLevel: 10,
                    color: 0xFF6B6B,
                    nextLevel: 'Edad Moderna',
                    description: 'Contexto histórico y pensamiento crítico',
                    lastActivity: 'Hace 5 días',
                    predictedDays: 35
                },
                {
                    id: 'ciudadania',
                    name: 'Ciudadanía Fiscal',
                    icon: 'fa-gavel',
                    currentLevel: 7,
                    maxLevel: 10,
                    color: 0x405086,
                    nextLevel: 'Derecho Mercantil',
                    description: 'Conocimiento legal y fiscal español',
                    lastActivity: 'Ayer',
                    predictedDays: 10
                },
                {
                    id: 'autosuficiencia',
                    name: 'Autosuficiencia',
                    icon: 'fa-seedling',
                    currentLevel: 2,
                    maxLevel: 10,
                    color: 0x8B4513,
                    nextLevel: 'Horticultura Básica',
                    description: 'Habilidades prácticas para la vida',
                    lastActivity: 'Hace 7 días',
                    predictedDays: 42
                }
            ],
            stats: {
                totalLevels: 42,
                streakDays: 12,
                growthRate: 23,
                badges: ['seedling', 'fire', 'bolt']
            }
        };

        // ==================== CONFIGURACIÓN THREE.JS ====================
        const container = document.getElementById('tree3dCanvas');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x0a1128, 0.012);

        const camera = new THREE.PerspectiveCamera(
            45,
            container.clientWidth / container.clientHeight,
            0.1,
            1000
        );
        camera.position.set(18, 15, 28);

        const renderer = new THREE.WebGLRenderer({
            canvas: container,
            antialias: true,
            alpha: false
        });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;

        // ==================== CONTROLES ====================
        const controls = {
            isDragging: false,
            previousMousePosition: { x: 0, y: 0 },
            rotationSpeed: 0.005,
            autoRotate: true,
            autoRotateSpeed: 0.001,
            currentMode: 'detailed'
        };

        container.addEventListener('mousedown', (e) => {
            controls.isDragging = true;
            controls.autoRotate = false;
            controls.previousMousePosition = { x: e.clientX, y: e.clientY };
        });

        container.addEventListener('mousemove', (e) => {
            if (controls.isDragging) {
                const deltaX = e.clientX - controls.previousMousePosition.x;
                const deltaY = e.clientY - controls.previousMousePosition.y;

                treeGroup.rotation.y += deltaX * controls.rotationSpeed;
                treeGroup.rotation.x += deltaY * controls.rotationSpeed;
                treeGroup.rotation.x = Math.max(-Math.PI / 3, Math.min(Math.PI / 3, treeGroup.rotation.x));

                controls.previousMousePosition = { x: e.clientX, y: e.clientY };
            }
        });

        container.addEventListener('mouseup', () => {
            controls.isDragging = false;
        });

        container.addEventListener('mouseleave', () => {
            controls.isDragging = false;
        });

        container.addEventListener('wheel', (e) => {
            e.preventDefault();
            camera.position.z += e.deltaY * 0.02;
            camera.position.z = Math.max(15, Math.min(45, camera.position.z));
        }, { passive: false });

        // ==================== ILUMINACIÓN ====================
        const ambientLight = new THREE.AmbientLight(0x6efacc, 0.3);
        scene.add(ambientLight);

        const hemisphereLight = new THREE.HemisphereLight(0x6efacc, 0x042454, 0.6);
        scene.add(hemisphereLight);

        const spotlight = new THREE.SpotLight(0xD1A517, 1.8);
        spotlight.position.set(18, 28, 18);
        spotlight.angle = Math.PI / 5;
        spotlight.penumbra = 0.3;
        spotlight.decay = 2;
        spotlight.distance = 60;
        spotlight.castShadow = true;
        spotlight.shadow.mapSize.width = 2048;
        spotlight.shadow.mapSize.height = 2048;
        scene.add(spotlight);

        const fillLight = new THREE.DirectionalLight(0x405086, 0.5);
        fillLight.position.set(-12, 12, -12);
        scene.add(fillLight);

        const rimLight = new THREE.PointLight(0x6efacc, 1, 35);
        rimLight.position.set(-10, 6, -18);
        scene.add(rimLight);

        // ==================== GRUPO PRINCIPAL ====================
        const treeGroup = new THREE.Group();
        scene.add(treeGroup);

        // ==================== TEXTURAS ====================
        function createWoodTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');

            const gradient = ctx.createLinearGradient(0, 0, 512, 512);
            gradient.addColorStop(0, '#3d2f1f');
            gradient.addColorStop(0.5, '#2a1f15');
            gradient.addColorStop(1, '#1a110a');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 512, 512);

            for (let i = 0; i < 60; i++) {
                ctx.strokeStyle = `rgba(20, 15, 10, ${0.3 + Math.random() * 0.3})`;
                ctx.lineWidth = 1 + Math.random() * 2;
                ctx.beginPath();
                const x = Math.random() * 512;
                const y = Math.random() * 512;
                const length = 50 + Math.random() * 120;
                ctx.moveTo(x, y);
                ctx.bezierCurveTo(
                    x + Math.random() * 25 - 12, y + length * 0.3,
                    x + Math.random() * 25 - 12, y + length * 0.7,
                    x + Math.random() * 35 - 17, y + length
                );
                ctx.stroke();
            }

            for (let i = 0; i < 120; i++) {
                const x = Math.random() * 512;
                const y = Math.random() * 512;
                const size = Math.random() * 3;
                ctx.fillStyle = `rgba(10, 8, 5, ${0.4 + Math.random() * 0.3})`;
                ctx.fillRect(x, y, size, size);
            }

            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;
            return texture;
        }

        function createBarkTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');

            ctx.fillStyle = '#1a110a';
            ctx.fillRect(0, 0, 512, 512);

            for (let i = 0; i < 35; i++) {
                ctx.strokeStyle = `rgba(0, 0, 0, ${0.5 + Math.random() * 0.3})`;
                ctx.lineWidth = 2 + Math.random() * 4;
                const x = Math.random() * 512;
                ctx.beginPath();
                ctx.moveTo(x, 0);

                let currentY = 0;
                while (currentY < 512) {
                    currentY += 20 + Math.random() * 40;
                    const offsetX = (Math.random() - 0.5) * 18;
                    ctx.lineTo(x + offsetX, currentY);
                }
                ctx.stroke();
            }

            for (let i = 0; i < 25; i++) {
                const x = Math.random() * 512;
                const y = Math.random() * 512;
                const radius = 12 + Math.random() * 22;

                const gradient = ctx.createRadialGradient(x, y, 0, x, y, radius);
                gradient.addColorStop(0, 'rgba(10, 8, 5, 0.8)');
                gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fill();
            }

            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;
            return texture;
        }

        const woodTexture = createWoodTexture();
        const barkTexture = createBarkTexture();

        const woodMaterial = new THREE.MeshStandardMaterial({
            map: woodTexture,
            bumpMap: barkTexture,
            bumpScale: 0.35,
            roughness: 0.9,
            metalness: 0.1,
            color: 0x4a3422
        });

        // ==================== GEOMETRÍA ====================
        function createBranch(length, radiusTop, radiusBottom, segments = 8) {
            const geometry = new THREE.CylinderGeometry(
                radiusTop,
                radiusBottom,
                length,
                segments,
                segments,
                false
            );

            const positions = geometry.attributes.position;
            for (let i = 0; i < positions.count; i++) {
                const x = positions.getX(i);
                const y = positions.getY(i);
                const z = positions.getZ(i);

                const wave = Math.sin(y * 0.5) * 0.12;
                positions.setX(i, x + wave * Math.sin(i * 0.5));
                positions.setZ(i, z + wave * Math.cos(i * 0.5));

                const noise = (Math.random() - 0.5) * 0.06;
                positions.setX(i, x + noise);
                positions.setZ(i, z + noise);
            }

            geometry.attributes.position.needsUpdate = true;
            geometry.computeVertexNormals();

            return geometry;
        }

        // Tronco
        const trunkGeometry = createBranch(9, 0.45, 0.9, 14);
        const trunk = new THREE.Mesh(trunkGeometry, woodMaterial);
        trunk.position.y = 4.5;
        trunk.castShadow = true;
        trunk.receiveShadow = true;
        treeGroup.add(trunk);

        const leaves = [];
        const fruits = [];
        const branchMeshes = [];

        // Sistema de ramas con datos del estudiante
        function addBranches(parent, startPos, direction, length, radius, depth, maxDepth, branchData) {
            if (depth > maxDepth || length < 0.5) return;

            const branchGeometry = createBranch(length, radius * 0.7, radius, 8);
            const branch = new THREE.Mesh(branchGeometry, woodMaterial);

            branch.position.copy(startPos);
            branch.position.y += length / 2;

            const axis = new THREE.Vector3(0, 1, 0);
            const angle = Math.acos(axis.dot(direction));
            const rotAxis = new THREE.Vector3().crossVectors(axis, direction).normalize();
            if (rotAxis.length() > 0) {
                branch.rotateOnAxis(rotAxis, angle);
            }

            branch.castShadow = true;
            branch.receiveShadow = true;

            // Asociar datos del estudiante
            if (branchData && depth === 1) {
                branch.userData.branchData = branchData;
                branch.userData.isClickable = true;
                branchMeshes.push(branch);

                // Color basado en progreso
                const progress = branchData.currentLevel / branchData.maxLevel;
                let emissiveColor = new THREE.Color();
                if (progress < 0.3) emissiveColor.setHex(0xFF6B6B);
                else if (progress < 0.7) emissiveColor.setHex(0xFFD93D);
                else if (progress < 1.0) emissiveColor.setHex(0x6BCF7F);
                else emissiveColor.setHex(0xD1A517);

                branch.material = woodMaterial.clone();
                branch.material.emissive = emissiveColor;
                branch.material.emissiveIntensity = 0.2 * progress;
            }

            treeGroup.add(branch);

            const endPos = startPos.clone().add(direction.clone().multiplyScalar(length));

            if (depth > maxDepth - 2) {
                addLeafCluster(endPos, depth, branchData);
            }

            if (depth > maxDepth - 2 && branchData && branchData.currentLevel >= branchData.maxLevel * 0.8) {
                addFruit(endPos, branchData);
            }

            if (depth < maxDepth) {
                const numChildren = 2 + (depth < 2 ? 1 : 0);
                for (let i = 0; i < numChildren; i++) {
                    const angle = (Math.PI / 4) + (Math.random() - 0.5) * (Math.PI / 6);
                    const rotation = (i - (numChildren - 1) / 2) * (Math.PI / numChildren) * 1.5;

                    const newDir = direction.clone();
                    newDir.applyAxisAngle(new THREE.Vector3(0, 1, 0), rotation);
                    newDir.applyAxisAngle(
                        new THREE.Vector3(Math.cos(rotation), 0, Math.sin(rotation)),
                        angle
                    );
                    newDir.normalize();

                    const newLength = length * (0.62 + Math.random() * 0.14);
                    const newRadius = radius * 0.75;

                    addBranches(branch, endPos, newDir, newLength, newRadius, depth + 1, maxDepth, branchData);
                }
            }
        }

        function addLeafCluster(position, generation, branchData) {
            const numLeaves = 4 + Math.floor(Math.random() * 5);
            const leafColor = branchData ? branchData.color : 0x6efacc;

            const leafMaterial = new THREE.MeshStandardMaterial({
                color: leafColor,
                emissive: leafColor,
                emissiveIntensity: 0.25,
                roughness: 0.7,
                metalness: 0.3,
                side: THREE.DoubleSide
            });

            for (let i = 0; i < numLeaves; i++) {
                const leafGeometry = new THREE.CircleGeometry(0.35 + Math.random() * 0.25, 6);
                const leaf = new THREE.Mesh(leafGeometry, leafMaterial);

                leaf.position.copy(position);
                leaf.position.x += (Math.random() - 0.5) * 1.2;
                leaf.position.y += (Math.random() - 0.5) * 1.2;
                leaf.position.z += (Math.random() - 0.5) * 1.2;

                leaf.rotation.x = Math.random() * Math.PI;
                leaf.rotation.y = Math.random() * Math.PI;
                leaf.rotation.z = Math.random() * Math.PI;

                leaf.castShadow = true;
                leaf.userData.swayPhase = Math.random() * Math.PI * 2;
                leaf.userData.swaySpeed = 0.5 + Math.random() * 0.5;
                leaf.userData.baseRotation = leaf.rotation.clone();

                if (branchData) {
                    leaf.userData.branchData = branchData;
                }

                treeGroup.add(leaf);
                leaves.push(leaf);
            }
        }

        function addFruit(position, branchData) {
            const fruitMaterial = new THREE.MeshStandardMaterial({
                color: 0xD1A517,
                emissive: 0xFFD700,
                emissiveIntensity: 0.6,
                roughness: 0.2,
                metalness: 0.9
            });

            const fruitGeometry = new THREE.OctahedronGeometry(0.22 + Math.random() * 0.12, 1);
            const fruit = new THREE.Mesh(fruitGeometry, fruitMaterial);

            fruit.position.copy(position);
            fruit.position.y -= 0.35;

            fruit.castShadow = true;
            fruit.userData.pulsePhase = Math.random() * Math.PI * 2;
            fruit.userData.baseY = fruit.position.y;

            if (branchData) {
                fruit.userData.branchData = branchData;
            }

            const fruitLight = new THREE.PointLight(0xD1A517, 0.4, 2.5);
            fruitLight.position.copy(fruit.position);
            treeGroup.add(fruitLight);
            fruit.userData.light = fruitLight;

            treeGroup.add(fruit);
            fruits.push(fruit);
        }

        // Generar ramas con datos del estudiante
        studentData.branches.forEach((branchData, index) => {
            const angle = (index / studentData.branches.length) * Math.PI * 2;
            const startPos = new THREE.Vector3(0, 8.5, 0);
            const direction = new THREE.Vector3(
                Math.cos(angle) * 0.55,
                0.75,
                Math.sin(angle) * 0.55
            ).normalize();

            addBranches(null, startPos, direction, 3.5, 0.38, 0, 4, branchData);
        });

        // Suelo
        const groundGeometry = new THREE.CircleGeometry(22, 36);
        const groundMaterial = new THREE.MeshStandardMaterial({
            color: 0x0a1128,
            roughness: 0.95,
            metalness: 0.05
        });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = 0;
        ground.receiveShadow = true;
        scene.add(ground);

        // Partículas
        const particlesGeometry = new THREE.BufferGeometry();
        const particlesCount = 250;
        const positions = new Float32Array(particlesCount * 3);

        for (let i = 0; i < particlesCount * 3; i += 3) {
            positions[i] = (Math.random() - 0.5) * 45;
            positions[i + 1] = Math.random() * 25;
            positions[i + 2] = (Math.random() - 0.5) * 45;
        }

        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

        const particlesMaterial = new THREE.PointsMaterial({
            size: 0.12,
            color: 0x6efacc,
            transparent: true,
            opacity: 0.7,
            blending: THREE.AdditiveBlending
        });

        const particles = new THREE.Points(particlesGeometry, particlesMaterial);
        scene.add(particles);

        // ==================== RAYCASTER PARA CLICKS ====================
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        container.addEventListener('click', (event) => {
            const rect = container.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(branchMeshes);

            if (intersects.length > 0) {
                const clickedBranch = intersects[0].object;
                if (clickedBranch.userData.branchData) {
                    showBranchInfo(clickedBranch.userData.branchData);
                    triggerCelebration('mini');
                }
            }
        });

        // ==================== UI FUNCTIONS ====================
        function showBranchInfo(branchData) {
            const content = document.getElementById('branchInfoContent');
            const progress = (branchData.currentLevel / branchData.maxLevel) * 100;

            content.innerHTML = `
                <div class="branch-info">
                    <div class="branch-name">
                        <i class="fas ${branchData.icon}"></i>
                        ${branchData.name}
                    </div>
                    <p style="margin: 10px 0; opacity: 0.8;">${branchData.description}</p>

                    <div class="branch-progress">
                        <div class="progress-label">
                            <span>Nivel ${branchData.currentLevel} de ${branchData.maxLevel}</span>
                            <span>${progress.toFixed(0)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>

                    <div class="next-level">
                        <div class="next-level-title">
                            <i class="fas fa-arrow-right"></i> Próximo Nivel
                        </div>
                        <div class="next-level-desc">
                            ${branchData.nextLevel}
                        </div>
                        <p style="font-size: 0.85rem; margin-top: 8px; opacity: 0.7;">
                            <i class="fas fa-clock"></i> Última actividad: ${branchData.lastActivity}
                        </p>
                        <p style="font-size: 0.85rem; opacity: 0.7;">
                            <i class="fas fa-chart-line"></i> Predicción: ${branchData.predictedDays} días para siguiente nivel
                        </p>
                    </div>

                    <button class="action-btn" onclick="window.location.href='#continue-learning'">
                        <i class="fas fa-play"></i>
                        Continuar Aprendiendo
                    </button>
                </div>
            `;
        }

        function triggerCelebration(type = 'full') {
            const container = document.getElementById('celebrationContainer');
            const count = type === 'full' ? 100 : 30;
            const colors = ['#D1A517', '#6efacc', '#FFD700', '#6BCF7F'];

            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                    confetti.style.animationDelay = (Math.random() * 0.5) + 's';
                    container.appendChild(confetti);

                    setTimeout(() => confetti.remove(), 4000);
                }, i * 20);
            }
        }

        function updateMotivationalMessage() {
            const messages = [
                { icon: 'fa-fire', text: `¡Excelente! Llevas ${studentData.stats.streakDays} días consecutivos aprendiendo.` },
                { icon: 'fa-chart-line', text: `Tu árbol ha crecido un ${studentData.stats.growthRate}% este mes. ¡Sigue así!` },
                { icon: 'fa-star', text: `Has certificado ${studentData.stats.totalLevels} niveles. ¡Impresionante progreso!` },
                { icon: 'fa-trophy', text: `Estás en el camino correcto. Solo ${3 - studentData.stats.badges.length} logros más para el siguiente hito.` }
            ];

            const message = messages[Math.floor(Math.random() * messages.length)];
            const banner = document.getElementById('motivationBanner');
            banner.querySelector('.motivation-icon i').className = `fas ${message.icon}`;
            document.getElementById('motivationText').textContent = message.text;
        }

        // ==================== TOUR GUIADO ====================
        const tourSteps = [
            {
                icon: 'fa-seedling',
                title: 'Bienvenido a tu Árbol de Conocimiento',
                message: 'Este es tu espacio personal de aprendizaje. Cada rama representa un área de conocimiento que irás desarrollando a tu ritmo.'
            },
            {
                icon: 'fa-code-branch',
                title: 'Las Ramas del Conocimiento',
                message: 'Cada rama tiene un color que indica tu progreso: rojo (requiere atención), amarillo (en progreso), verde (bien encaminado), y dorado (excelencia alcanzada).'
            },
            {
                icon: 'fa-leaf',
                title: 'Hojas y Frutos',
                message: 'Las hojas verdes representan niveles certificados. Los frutos dorados brillantes son niveles completados con excelencia (>90% de puntuación).'
            },
            {
                icon: 'fa-hand-pointer',
                title: 'Explora e Interactúa',
                message: 'Arrastra para rotar el árbol, usa la rueda del ratón para acercar, y haz click en las ramas para ver información detallada y tu roadmap de aprendizaje.'
            },
            {
                icon: 'fa-rocket',
                title: '¡Comienza tu Viaje!',
                message: 'Tu árbol crecerá contigo. Cada nuevo nivel certificado lo hará más fuerte y más hermoso. ¡Empieza a aprender y observa cómo florece!'
            }
        ];

        let currentTourStep = 0;

        function showTourStep(step) {
            const overlay = document.getElementById('tourOverlay');
            const tourData = tourSteps[step];

            document.getElementById('tourIcon').innerHTML = `<i class="fas ${tourData.icon}"></i>`;
            document.getElementById('tourTitle').textContent = tourData.title;
            document.getElementById('tourMessage').textContent = tourData.message;
            document.getElementById('tourProgress').textContent = `Paso ${step + 1} de ${tourSteps.length}`;

            if (step === tourSteps.length - 1) {
                document.getElementById('tourNext').textContent = 'Comenzar';
            } else {
                document.getElementById('tourNext').textContent = 'Siguiente';
            }

            overlay.classList.add('active');
        }

        function closeTour() {
            document.getElementById('tourOverlay').classList.remove('active');
            controls.autoRotate = true;
            localStorage.setItem('kobaltoTourCompleted', 'true');
        }

        document.getElementById('tourNext').addEventListener('click', () => {
            currentTourStep++;
            if (currentTourStep >= tourSteps.length) {
                closeTour();
                triggerCelebration('full');
                currentTourStep = 0;
            } else {
                showTourStep(currentTourStep);
            }
        });

        document.getElementById('tourSkip').addEventListener('click', closeTour);

        document.getElementById('restartTour').addEventListener('click', () => {
            currentTourStep = 0;
            showTourStep(0);
        });

        // ==================== VIEW MODES ====================
        document.getElementById('viewMode3D').addEventListener('click', function() {
            document.getElementById('canvas3DContainer').style.display = 'block';
            document.getElementById('tree2DView').classList.remove('active');
            document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });

        document.getElementById('viewMode2D').addEventListener('click', function() {
            document.getElementById('canvas3DContainer').style.display = 'none';
            document.getElementById('tree2DView').classList.add('active');
            populate2DView();
            document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });

        function populate2DView() {
            const diagram = document.getElementById('branchesDiagram');
            diagram.innerHTML = '';

            studentData.branches.forEach(branch => {
                const progress = branch.currentLevel / branch.maxLevel;
                let status = 'status-low';
                if (progress >= 0.7) status = 'status-high';
                else if (progress >= 0.3) status = 'status-medium';
                if (progress >= 1.0) status = 'status-excellent';

                const branchDiv = document.createElement('div');
                branchDiv.className = `branch-2d ${status}`;
                branchDiv.innerHTML = `
                    <div class="branch-name">
                        <i class="fas ${branch.icon}"></i>
                        ${branch.name}
                    </div>
                    <p style="margin: 10px 0; opacity: 0.8;">${branch.description}</p>
                    <div class="branch-progress">
                        <div class="progress-label">
                            <span>Nivel ${branch.currentLevel} de ${branch.maxLevel}</span>
                            <span>${(progress * 100).toFixed(0)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress * 100}%"></div>
                        </div>
                    </div>
                `;
                diagram.appendChild(branchDiv);
            });
        }

        document.getElementById('viewModeOverview').addEventListener('click', function() {
            controls.currentMode = 'overview';
            camera.position.set(22, 18, 32);
            document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });

        document.getElementById('viewModeDetailed').addEventListener('click', function() {
            controls.currentMode = 'detailed';
            camera.position.set(18, 15, 28);
            document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });

        // ==================== ANIMACIÓN ====================
        let time = 0;
        function animate() {
            requestAnimationFrame(animate);
            time += 0.01;

            if (controls.autoRotate) {
                treeGroup.rotation.y += controls.autoRotateSpeed;
            }

            leaves.forEach(leaf => {
                const sway = Math.sin(time * leaf.userData.swaySpeed + leaf.userData.swayPhase) * 0.1;
                leaf.rotation.z = leaf.userData.baseRotation.z + sway;
                leaf.rotation.x = leaf.userData.baseRotation.x + sway * 0.5;
            });

            fruits.forEach(fruit => {
                const pulse = Math.sin(time * 2 + fruit.userData.pulsePhase) * 0.06;
                fruit.position.y = fruit.userData.baseY + pulse;
                fruit.rotation.y += 0.01;

                if (fruit.userData.light) {
                    fruit.userData.light.intensity = 0.4 + pulse * 2.5;
                }
            });

            particles.rotation.y += 0.0003;
            const particlePositions = particles.geometry.attributes.position.array;
            for (let i = 1; i < particlesCount * 3; i += 3) {
                particlePositions[i] += 0.012;
                if (particlePositions[i] > 25) {
                    particlePositions[i] = 0;
                }
            }
            particles.geometry.attributes.position.needsUpdate = true;

            spotlight.position.x = Math.cos(time * 0.2) * 18;
            spotlight.position.z = Math.sin(time * 0.2) * 18;

            renderer.render(scene, camera);
        }

        // ==================== INICIALIZACIÓN ====================
        function init() {
            animate();
            updateMotivationalMessage();

            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');

                // Mostrar tour si es primera vez
                if (!localStorage.getItem('kobaltoTourCompleted')) {
                    setTimeout(() => showTourStep(0), 500);
                } else {
                    controls.autoRotate = true;
                }
            }, 2000);

            // Actualizar mensaje motivacional cada 30 segundos
            setInterval(updateMotivationalMessage, 30000);
        }

        // ==================== RESPONSIVE ====================
        function handleResize() {
            const width = container.clientWidth;
            const height = container.clientHeight;

            camera.aspect = width / height;
            camera.updateProjectionMatrix();

            renderer.setSize(width, height);
        }

        window.addEventListener('resize', handleResize);

        // Touch controls
        let touchStartX = 0;
        let touchStartY = 0;

        container.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            controls.autoRotate = false;
        });

        container.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const deltaX = e.touches[0].clientX - touchStartX;
            const deltaY = e.touches[0].clientY - touchStartY;

            treeGroup.rotation.y += deltaX * controls.rotationSpeed * 0.5;
            treeGroup.rotation.x += deltaY * controls.rotationSpeed * 0.5;
            treeGroup.rotation.x = Math.max(-Math.PI / 3, Math.min(Math.PI / 3, treeGroup.rotation.x));

            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }, { passive: false });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') treeGroup.rotation.y -= 0.1;
            if (e.key === 'ArrowRight') treeGroup.rotation.y += 0.1;
            if (e.key === 'ArrowUp') camera.position.z -= 2;
            if (e.key === 'ArrowDown') camera.position.z += 2;
        });

        init();
    </script>
</body>
</html>
